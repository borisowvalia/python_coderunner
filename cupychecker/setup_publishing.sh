#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–∞–∫–µ—Ç–∞ cupychecker

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${GREEN}üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ cupychecker${NC}"
echo "=================================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º Python
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}‚ùå Python3 –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python 3.7+${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ Python3 –Ω–∞–π–¥–µ–Ω: $(python3 --version)${NC}"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo -e "${YELLOW}üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏...${NC}"
pip3 install --upgrade setuptools wheel build twine

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞–∫–µ—Ç –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
echo -e "${YELLOW}üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø–∞–∫–µ—Ç –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏...${NC}"
pip3 install -e .

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
echo -e "${YELLOW}üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤...${NC}"
pip3 install -r ../tests/requirements-test.txt

# –°–æ–∑–¥–∞–µ–º .pypirc –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
if [ ! -f ".pypirc" ]; then
    echo -e "${YELLOW}üìù –°–æ–∑–¥–∞—é .pypirc –∏–∑ –ø—Ä–∏–º–µ—Ä–∞...${NC}"
    cp .pypirc.example .pypirc
    echo -e "${YELLOW}‚ö†Ô∏è  –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .pypirc –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏ API —Ç–æ–∫–µ–Ω—ã${NC}"
else
    echo -e "${GREEN}‚úÖ .pypirc —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º git
if command -v git &> /dev/null; then
    echo -e "${GREEN}‚úÖ Git –Ω–∞–π–¥–µ–Ω: $(git --version)${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Git –Ω–µ –Ω–∞–π–¥–µ–Ω. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–≥–æ–≤${NC}"
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
echo -e "${YELLOW}üß™ –ó–∞–ø—É—Å–∫–∞—é —Ç–µ—Å—Ç—ã...${NC}"
cd ../tests
if python3 run_tests.py; then
    echo -e "${GREEN}‚úÖ –¢–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!${NC}"
else
    echo -e "${RED}‚ùå –¢–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π${NC}"
    exit 1
fi

cd ../cupychecker

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
echo -e "${YELLOW}üì¶ –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:${NC}"
python3 -c "import re; content=open('setup.cfg').read(); print(re.search(r'version\s*=\s*([^\s\n]+)', content).group(1))"

echo ""
echo -e "${GREEN}üéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${NC}"
echo ""
echo -e "${YELLOW}–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:${NC}"
echo "1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .pypirc –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏ API —Ç–æ–∫–µ–Ω—ã"
echo "2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø—É–±–ª–∏–∫–∞—Ü–∏—é –Ω–∞ TestPyPI:"
echo "   ./publish.sh publish-test"
echo "3. –ü—É–±–ª–∏–∫—É–π—Ç–µ –Ω–∞ PyPI:"
echo "   ./publish.sh publish"
echo ""
echo -e "${YELLOW}–ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:${NC}"
echo "  ./publish.sh help     - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É"
echo "  ./publish.sh test     - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã"
echo "  ./publish.sh build    - –°–æ–±—Ä–∞—Ç—å –ø–∞–∫–µ—Ç"
echo "  make help             - –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã make"
echo ""
echo -e "${BLUE}–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: PUBLISH.md${NC}"
